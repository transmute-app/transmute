name: Notify on Issue Events

on:
  issues:
    types: [opened, closed, edited]
  issue_comment:
    types: [created]

permissions:
  issues: read

jobs:
  notify-on-issue:
    if: ${{ github.actor != github.repository_owner }}
    runs-on: ubuntu-latest
    steps:
      - name: Get Embed
        id: get-embed
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_STATE: ${{ github.event.issue.state }}
          ISSUE_LABELS: ${{ toJson(github.event.issue.labels) }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          EVENT_ACTION: ${{ github.event.action }}
        run: |
          # Create individual field objects
          FIELD_NUMBER=$(jq -nc --arg value "$ISSUE_NUMBER" \
            '{"name":"#ï¸âƒ£ Number","value":$value, "inline": true}')
          FIELD_STATE=$(jq -nc --arg value "$ISSUE_STATE" \
            '{"name":"ðŸ“‹ State","value":$value, "inline": true}')
          FIELD_LABELS=$(jq -nc --argjson value "$ISSUE_LABELS" \
            '{"name":"ðŸ·ï¸ Labels","value":($value | map(.name) | join(", ")), "inline": false}')
          
          # Add comment/update field if applicable
          if [ "$EVENT_ACTION" = "created" ] && [ -n "$COMMENT_BODY" ]; then
            FIELD_COMMENT=$(jq -nc --arg value "$COMMENT_BODY" --arg user "$GITHUB_ACTOR" \
              '{"name":"ðŸ’¬ Comment from \($user)","value":$value, "inline": false}')
            FIELDS_JSON=$(jq -nc \
                  --argjson number "$FIELD_NUMBER" \
                  --argjson state "$FIELD_STATE" \
                  --argjson labels "$FIELD_LABELS" \
                  --argjson comment "$FIELD_COMMENT" \
                  '[$number, $state, $labels, $comment]')
          elif [ "$EVENT_ACTION" = "edited" ]; then
            FIELD_UPDATE=$(jq -nc --arg value "Issue was updated by $GITHUB_ACTOR" \
              '{"name":"âœï¸ Update","value":$value, "inline": false}')
            FIELDS_JSON=$(jq -nc \
                  --argjson number "$FIELD_NUMBER" \
                  --argjson state "$FIELD_STATE" \
                  --argjson labels "$FIELD_LABELS" \
                  --argjson update "$FIELD_UPDATE" \
                  '[$number, $state, $labels, $update]')
          else
            FIELDS_JSON=$(jq -nc \
                  --argjson number "$FIELD_NUMBER" \
                  --argjson state "$FIELD_STATE" \
                  --argjson labels "$FIELD_LABELS" \
                  '[$number, $state, $labels]')
          fi
          echo "fields_json=$FIELDS_JSON" >> $GITHUB_OUTPUT
    
      - name: Check for Discord Webhook URL
        id: discord-check
        run: |
          if [ -z "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            echo "::warning::DISCORD_WEBHOOK_URL is not set."
            echo "has_webhook=false" >> $GITHUB_OUTPUT
          else
            echo "::notice::DISCORD_WEBHOOK_URL is set."
            echo "has_webhook=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Message to Discord
        if: ${{ steps.discord-check.outputs.has_webhook == 'true' }}
        uses: chase-roohms/discord-notify@v1
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: ${{ github.repository }}
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
          embed-titles: "Issue: ${{ github.event.issue.title }}"
          embed-descriptions: ${{ github.event.issue.body }}
          embed-urls: ${{ github.event.issue.html_url }}
          embed-colors: "#E5A00D"
          embed-fields: ${{ steps.get-embed.outputs.fields_json }}
          embed-authors: ${{ github.event.issue.user.login }}
          embed-author-urls: ${{ github.event.issue.user.html_url }}
          embed-author-icons: ${{ github.event.issue.user.avatar_url }}
          embed-timestamps: 'now'